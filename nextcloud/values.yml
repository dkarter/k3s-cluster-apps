# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/app-template-4.4.0/charts/other/app-template/values.schema.json

# Prevent scheduling on control plane - k3s0 has service networking issues
defaultPodOptions:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: DoesNotExist

controllers:
  nextcloud:
    strategy: Recreate
    replicas: 1

    containers:
      app:
        image:
          repository: nextcloud
          tag: 32.0.2
          pullPolicy: IfNotPresent

        env:
          NEXTCLOUD_TRUSTED_DOMAINS: nextcloud.k3s.pro nc.tnnl.me
          POSTGRES_HOST: db-rw.nextcloud.svc.cluster.local:5432
          POSTGRES_DB: app
          REDIS_HOST: nextcloud-redis.nextcloud.svc.cluster.local
          NEXTCLOUD_ADMIN_USER:
            valueFrom:
              secretKeyRef:
                name: nextcloud-admin
                key: username
          NEXTCLOUD_ADMIN_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: nextcloud-admin
                key: password
          POSTGRES_USER:
            valueFrom:
              secretKeyRef:
                name: db-app
                key: username
          POSTGRES_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: db-app
                key: password

        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /status.php
                port: 80
              initialDelaySeconds: 60
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 5
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /status.php
                port: 80
              initialDelaySeconds: 30
              periodSeconds: 10

  redis:
    containers:
      app:
        image:
          repository: redis
          tag: 7.4.7-alpine
          pullPolicy: IfNotPresent

        command:
          - redis-server
          - --save
          - '60'
          - '1'
          - --loglevel
          - warning

  cloudflared:
    containers:
      app:
        image:
          repository: cloudflare/cloudflared
          tag: 2025.11.1
          pullPolicy: IfNotPresent

        args:
          - tunnel
          - --no-autoupdate
          - run
          - --token
          - $(TUNNEL_TOKEN)

        env:
          TUNNEL_TOKEN:
            valueFrom:
              secretKeyRef:
                name: cloudflare-tunnel-credentials
                key: tunnel_token

        probes:
          liveness:
            enabled: false

persistence:
  config:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 10Gi
    advancedMounts:
      nextcloud:
        app:
          - path: /var/www/html

  data:
    type: persistentVolumeClaim
    existingClaim: nextcloud-nas-data
    advancedMounts:
      nextcloud:
        app:
          - path: /var/www/html/data

  redis-data:
    type: emptyDir
    advancedMounts:
      redis:
        app:
          - path: /data

service:
  nextcloud:
    controller: nextcloud
    ports:
      http:
        port: 80

  redis:
    controller: redis
    ports:
      redis:
        port: 6379

  cloudflared-metrics:
    controller: cloudflared
    ports:
      metrics:
        port: 2000

ingress:
  main:
    enabled: true
    annotations:
      # Homepage integration
      gethomepage.dev/enabled: 'true'
      gethomepage.dev/name: Nextcloud
      gethomepage.dev/description: File Sharing & Collaboration
      gethomepage.dev/group: Apps
      gethomepage.dev/icon: nextcloud.svg
      gethomepage.dev/siteMonitor: 'https://nextcloud.k3s.pro'

      # cert-manager
      kubernetes.io/ingress.class: 'traefik'
      cert-manager.io/cluster-issuer: 'letsencrypt'
    className: 'traefik'
    hosts:
      - host: &host 'nextcloud.k3s.pro'
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: nextcloud
              port: http
    tls:
      - hosts:
          - *host
        secretName: nextcloud-ingress-cert
